================================================================================
SPÉCIFICATIONS - SCRIPT DE PATCHING AUTOMATIQUE VPS UBUNTU
================================================================================

1. OBJECTIF
================================================================================
Créer un script automatisé qui effectue la mise à jour système complète (patching)
de la VPS Ubuntu tous les mercredis matins à une heure prédéfinie.

2. ENVIRONNEMENT
================================================================================
- Système d'exploitation : Ubuntu (LTS recommandé)
- Utilisateur d'exécution : root ou utilisateur avec accès sudo
- Fréquence : Hebdomadaire, tous les mercredis matin
- Heure d'exécution : 02h00 UTC (configurable)

3. FONCTIONNALITÉS PRINCIPALES
================================================================================

3.1 Mise à jour des paquets
   - Exécuter `apt-get update` pour rafraîchir la liste des paquets
   - Exécuter `apt-get upgrade -y` pour installer les mises à jour disponibles
   - Installer également les sécurité-patching critiques
   - Nettoyer les paquets obsolètes avec `apt-get autoremove -y`

3.2 Gestion des dépendances
   - Vérifier la validité des dépendances après mise à jour
   - Corriger les dépendances cassées si nécessaire

3.3 Redémarrage 
   - redemarrage du systeme
   - vérifier que l'ensemble des applications critiques ont bien redemarrée

4. JOURNALISATION ET MONITORING
================================================================================

4.1 Logs
   - Enregistrer tous les événements dans un fichier dédié
   - Chemin des logs : `/var/log/patching/patching-$(date +%Y-%m-%d).log`
   - Format : [TIMESTAMP] [NIVEAU] Message
   - Conserver les logs pendant 90 jours minimum

4.2 Rapports d'exécution
   - Générer un rapport de synthèse après chaque patching
   - Inclure : 
     * Date/heure d'exécution
     * Nombre de paquets mis à jour
     * Nombre d'erreurs rencontrées
     * Status global (SUCCÈS / AVERTISSEMENT / ERREUR)
     * Redémarrage effectué ou programmé (oui/non)

4.3 Notifications
   - Envoyer une notification par api avec un rapport en cas de succes et d'echec
   - Destinataires : endpoint 

5. PLANIFICATION (CRON)
================================================================================

5.1 Configuration crontab
   - Ajouter entrée dans crontab de root
   - Format : 0 2 * * 3 /opt/patching/patch-vps.sh
   - Explication : 
     * 0     = minute 0
     * 2     = heure 02:00 UTC
     * *     = tous les jours du mois
     * *     = tous les mois
     * 3     = mercredi (0=dimanche, 3=mercredi)

5.2 Synchronisation timezone
   - Vérifier la timezone du serveur avant planification
   - Adapter l'heure si nécessaire (utiliser `timedatectl`)

6. PRÉREQUIS TECHNIQUES
================================================================================

6.1 Droits et permissions
   - Script exécutable en root ou avec sudo sans password
   - Configuration sudoers pour permettre apt-get sans password (si nécessaire)

6.2 Dépendances système
   - Package `apt` et `apt-get` (standards sur Ubuntu)
   - Package `mail` ou `mailutils` (pour notifications email)
   - Package `curl` ou `wget` (optionnel, pour webhooks)

6.3 Répertoires requis
   - /opt/patching/ (répertoire du script)
   - /var/log/patching/ (répertoire des logs)
   - Créer les répertoires avec permissions 755

7. GESTION DES ERREURS
================================================================================

7.1 Détection d'erreurs
   - Capturer les codes de retour de chaque commande
   - Arrêter le script en cas d'erreur critique
   - Continuer pour les erreurs non-bloquantes

7.2 Cas d'erreur spécifiques
   - Paquets non mettables à jour : enregistrer et continuer
   - Processus en cours d'utilisation : relancer après délai ou programmer redémarrage
   - Espace disque insuffisant : enregistrer erreur et notifier

7.3 Mécanisme de retry
   - En cas d'échec, relancer l'opération 1 fois après 30 secondes
   - Après 2 tentatives échouées, envoyer alerte

8. SÉCURITÉ
================================================================================

8.1 Contrôle d'accès
   - Script accessible uniquement par root/administrateur
   - Permissions : 700 sur le script
   - Ownership : root:root

8.2 Intégrité
   - Valider les signatures des paquets durant apt
   - Vérifier GPG keys à jour

8.3 Audit
   - Tous les logs incluent timestamp et utilisateur
   - Maintenir un historique d'audit des modifications

9. STRUCTURE DU SCRIPT
================================================================================

Sections principales :
   1. Validation de l'environnement (root check, répertoires, etc.)
   2. Initialisation des variables et logs
   3. Sauvegarde pré-patching (état du système)
   4. Exécution des mises à jour
   5. Nettoyage post-patching
   6. Vérification redémarrage requis
   7. Génération rapport
   8. Notifications
   9. Nettoyage des logs anciens
  10. Exit avec code approprié

10. PARAMÈTRES CONFIGURABLES
================================================================================

Variables d'environnement ou fichier config :
   - PATCH_HOUR : Heure d'exécution (défaut : 02)
   - PATCH_DAY : Jour de la semaine (défaut : 3 pour mercredi)
   - LOG_RETENTION_DAYS : Jours de conservation des logs (défaut : 90)
   - EMAIL_RECIPIENT : Destinataire des alertes
   - ENABLE_REBOOT : Redémarrage automatique autorisé (true/false)
   - REBOOT_DELAY : Délai avant redémarrage en minutes (défaut : 10)

11. DOCUMENTATION
================================================================================

   - Fichier README.md avec instructions d'installation
   - Commentaires dans le code expliquant chaque section
   - Procédure de désactivation/réactivation du patching
   - Procédure de rollback en cas de problème

12. TESTS ET VALIDATION
================================================================================

   - Tester le script en mode dry-run (--dry-run)
   - Valider la syntaxe bash avant déploiement
   - Exécuter test sur serveur de staging
   - Valider les logs et notifications
   - Vérifier que le cron s'exécute à l'heure prévue

13. MAINTENANCE ET MONITORING
================================================================================

   - Vérifier mensuellement que le cron fonctionne
   - Analyser les patterns des mises à jour critiques
   - Maintenir une liste des redémarrages requis
   - Documenter tout problème rencontré et sa résolution

================================================================================
FIN DES SPÉCIFICATIONS
================================================================================
